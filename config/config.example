# 钉钉应用配置
dingtalk:
  app_key: "${DINGTALK_APP_KEY}"              # 钉钉企业应用的AppKey
  app_secret: "${DINGTALK_APP_SECRET}"        # 钉钉企业应用的AppSecret

# AI表格配置
spreadsheet:
  default_operator_id: "${DINGTALK_OPERATOR_ID}"  # 操作者ID（用于AI表格API，必填）

# 监听的审批流程配置
approvals:
  # 示例：请假审批
  - name: "测试审批"
    template_id: "PROC-75CEDE7A-8882-4C27-B279-04B65F487D5B" # 审批流程模板ID
    enabled: true
    # 审批通过后的操作
    actions:
      # 更新AI表格记录
      - type: "update_spreadsheet"
        base_id: "o14dA3GK8gxNA0Gdf5rkjEx5W9ekBD76"        # AI表格(Notable/多维表格)的Base ID
        sheet_id: "R5i0kXZ"             # 数据表ID或名称
        # 查找条件：根据审批表单中的字段查找匹配的记录
        find_by:
          field_name: "人员"        # AI表格中的字段名
          form_field: "联系人"    # 从审批表单中提取的字段名
        # 更新内容
        updates:
          - field_name: "部门"      # AI表格中的字段名
            form_field: "部门"   # 使用审批表单中的值
          - field_name: "事件"      # AI表格中的字段名
            form_field: "事件" # 使用审批表单中的值
          - field_name: "备注"      # AI表格中的字段名
            form_field: "备注"      

  # 示例：报销审批
  - name: "报销审批"
    template_id: "proc_reimbursement"
    enabled: true
    actions:
      - type: "update_spreadsheet"
        sheet_id: "sheet2"             # 数据表ID或名称
        find_by:
          field_name: "申请人ID"        # AI表格中的字段名
          form_field: "applicant_id"   # 从审批表单中提取的字段名
        updates:
          - field_name: "报销金额"      # AI表格中的字段名
            form_field: "amount"       # 使用审批表单中的值
          - field_name: "报销类别"      # AI表格中的字段名
            form_field: "category"     # 使用审批表单中的值
          - field_name: "状态"          # AI表格中的字段名
            value: "已通过"             # 使用固定值

  # 示例：使用Webhook转发
  - name: "采购审批"
    template_id: "proc_purchase"
    enabled: false
    actions:
      - type: "webhook"
        url: "https://your-server.com/api/webhook"
        method: "POST"
        headers:
          Authorization: "Bearer your_token"

  # 示例：执行Shell命令
  - name: "系统访问审批"
    template_id: "proc_system_access"
    enabled: false
    actions:
      - type: "shell"
        command: "/scripts/grant_access.sh"
        args:
          - "{form_data:user_id}"
          - "{form_data:resource_id}"

  # 示例：执行Python脚本
  - name: "数据导出审批"
    template_id: "proc_data_export"
    enabled: false
    actions:
      - type: "python"
        script: "/scripts/export_data.py"
        args:
          - "{form_data:export_type}"
          - "{form_data:date_range}"

# 监听的人事变动事件配置
# 注意：系统会自动获取用户的详细信息（姓名、部门、职位等）并合并到表单数据中
hrm_events:
  # 示例：离职事件（自动获取用户详细信息）
  - name: "离职事件"
    change_type: 4  # 4:离职
    enabled: false
    actions:
      - type: "update_spreadsheet"
        base_id: "your_base_id"        # AI表格(Notable/多维表格)的Base ID
        sheet_id: "your_sheet_id"      # 数据表ID或名称
        # 查找条件：根据员工ID查找匹配的记录
        find_by:
          field_name: "员工ID"         # AI表格中的字段名
          form_field: "staffId"        # 从人事变动事件中提取的字段名
        # 更新内容（可以使用自动获取的用户详细信息字段）
        updates:
          - field_name: "状态"          # AI表格中的字段名
            value: "已离职"             # 使用固定值
          - field_name: "离职时间"      # AI表格中的字段名
            timestamp: true            # 自动添加时间戳
          - field_name: "姓名"          # 使用自动获取的用户信息
            form_field: "name"          # 从用户详细信息中获取
          - field_name: "部门"          # 使用自动获取的用户信息
            form_field: "deptName"
          - field_name: "职位"          # 使用自动获取的用户信息
            form_field: "position"

  # 示例：入职事件（发送 Webhook 通知）
  - name: "入职事件"
    change_type: 1  # 1:入职
    enabled: false
    actions:
      # 发送 Webhook 通知，包含用户详细信息
      - type: "webhook"
        url: "https://your-server.com/api/onboarding"
        method: "POST"
        headers:
          Authorization: "Bearer your_token"
        body:
          event: "new_hire"
          employee_name: "{form_data:name}"
          employee_id: "{form_data:staffId}"
          department: "{form_data:deptName}"
          position: "{form_data:position}"
          mobile: "{form_data:mobile}"
          email: "{form_data:email}"

      # 同时更新表格
      - type: "update_spreadsheet"
        base_id: "your_base_id"
        sheet_id: "your_sheet_id"
        find_by:
          field_name: "员工ID"
          form_field: "staffId"
        updates:
          - field_name: "状态"
            value: "在职"
          - field_name: "入职时间"
            timestamp: true

  # 示例：转正事件（执行 Shell 脚本）
  - name: "转正事件"
    change_type: 2  # 2:转正
    enabled: false
    actions:
      - type: "shell"
        command: "/scripts/notify_regularization.sh"
        args:
          - "{form_data:name}"
          - "{form_data:staffId}"
          - "{form_data:deptName}"

      - type: "update_spreadsheet"
        base_id: "your_base_id"
        sheet_id: "your_sheet_id"
        find_by:
          field_name: "员工ID"
          form_field: "staffId"
        updates:
          - field_name: "员工状态"
            value: "正式员工"
          - field_name: "转正时间"
            timestamp: true

  # 示例：调岗事件（执行 Python 脚本）
  - name: "调岗事件"
    change_type: 3  # 3:调岗
    enabled: false
    actions:
      - type: "python"
        script: "/scripts/handle_transfer.py"

      - type: "update_spreadsheet"
        base_id: "your_base_id"
        sheet_id: "your_sheet_id"
        find_by:
          field_name: "员工ID"
          form_field: "staffId"
        updates:
          - field_name: "岗位变动"
            value: "是"
          - field_name: "姓名"
            form_field: "name"
          - field_name: "新部门"
            form_field: "deptName"
          - field_name: "新职位"
            form_field: "position"
          - field_name: "变动时间"
            timestamp: true

  # 示例：晋升事件（组合多个 Actions）
  - name: "晋升事件"
    change_type: 8  # 8:晋升
    enabled: false
    actions:
      # 1. 更新表格
      - type: "update_spreadsheet"
        base_id: "your_base_id"
        sheet_id: "your_sheet_id"
        find_by:
          field_name: "员工ID"
          form_field: "staffId"
        updates:
          - field_name: "姓名"
            form_field: "name"
          - field_name: "等级变动"
            value: "晋升"
          - field_name: "职位"
            form_field: "position"
          - field_name: "变动时间"
            timestamp: true

      # 2. 发送通知
      - type: "webhook"
        url: "https://your-server.com/api/promotion"
        method: "POST"
        body:
          employee: "{form_data:name}"
          old_position: "原职位"  # 固定值
          new_position: "{form_data:position}"

# 执行配置
execution:
  timeout: 300        # 操作超时时间(秒)
  retry_times: 2      # 失败重试次数
  retry_interval: 5   # 重试间隔(秒)

# 缓存配置
cache:
  # Access Token 缓存（默认2小时）
  access_token_ttl: 7200          # Access Token 缓存时间（秒）
  access_token_max_size: 10       # Access Token 最大缓存数

  # 用户信息缓存（默认10分钟）
  user_info_ttl: 600              # 用户信息缓存时间（秒）
  user_info_max_size: 1000        # 用户信息最大缓存数

  # 部门信息缓存（默认30分钟）
  dept_info_ttl: 1800             # 部门信息缓存时间（秒）
  dept_info_max_size: 500         # 部门信息最大缓存数

  # 其他设置
  enabled: true                    # 是否启用缓存
  cleanup_interval: 300            # 自动清理间隔（秒），5分钟清理一次过期缓存

# 日志配置
logging:
  level: "INFO"       # DEBUG, INFO, WARNING, ERROR
  file: "./logs/app.log"
  rotation: "100 MB"  # 日志文件大小限制
  retention: "30 days"  # 日志保留时间
